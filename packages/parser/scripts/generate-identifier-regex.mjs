import { promises as fs } from "node:fs";
// Based on https://gist.github.com/mathiasbynens/6334847 by @mathias
import * as url from "url";

import regenerate from "regenerate";
import idStartCodepoints from "@unicode/unicode-12.1.0/Binary_Property/ID_Start/code-points.js";
import idContinueCodepoints from "@unicode/unicode-12.1.0/Binary_Property/ID_Continue/code-points.js";
import otherIdStartCodepoints from "@unicode/unicode-12.1.0/Binary_Property/Other_ID_Start/code-points.js";

const __dirname = url.fileURLToPath(new url.URL(".", import.meta.url));

const generateRegex = async function () {
  // ES 6
  // https://mathiasbynens.be/notes/javascript-identifiers-es6
  const identifierStart = regenerate(idStartCodepoints).add("$", "_");
  const identifierContinue = regenerate(idContinueCodepoints)
    .add(otherIdStartCodepoints)
    .add("\u200C", "\u200D")
    .add("$", "_");

  await fs.writeFile(
    `${__dirname}/../src/identifiers.ts`,
    [
      "// This module is generated by `scripts/generate-identifier-regex`.",
      "/* eslint-disable no-misleading-character-class, no-useless-escape */",
      `export default /(?:${identifierStart.toString()})(?:${identifierContinue.toString()})*/g;`,
      "",
    ].join("\n"),
  );
};

await generateRegex();
